variables:
  - group: api-keys
  - name: Agent.Source.Git.ShallowFetchDepth
    value: 0
  - name: ProjectNamePattern
    value: ''

steps:
  - checkout: self
    submodules: true

  - script: |
      dotnet tool install --global GitVersion.Tool
      export PATH="$PATH:$HOME/.dotnet/tools"
      dotnet-gitversion /output buildserver
    displayName: GitVersion

  - script: echo "##vso[build.updatebuildnumber]$(GitVersion.FullSemVer)"
    displayName: Set Build Number

  - task: UseDotNet@2
    inputs:
      packageType: sdk
      version: '8.0.x'

  - script: dotnet build src/DotnetPackaging.DeployerTool/DotnetPackaging.DeployerTool.csproj -c Release
    displayName: Build DeployerTool

  - bash: |
      args=""
      if [ -n "$(ProjectNamePattern)" ]; then
        args="--name-pattern $(ProjectNamePattern)"
      fi
      dotnet run --project src/DotnetPackaging.DeployerTool/DotnetPackaging.DeployerTool.csproj -- \
        nuget --solution DotnetPackaging.sln --version $(Build.BuildNumber) --api-key $(NuGetApiKey) $args
    displayName: Publish Packages
